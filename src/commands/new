#!/bin/bash

###START###

# Create a new script
function new_command {
	require_dir $HOME_DIR

	script_name=${VALUES[0]}

	interactive_mode="false"
	if [ "$(is_flag_specified '-interactive' '-it')" == "true" ]; then
		interactive_mode="true"
	fi

	if [ -z "$script_name" ] && [ "$interactive_mode" == "false" ]; then
		log_e "Please provide the name for the new script"
		myexit 1
	fi

	if [ -z "$script_name" ] && [ "$interactive_mode" == "true" ]; then
		read -p "Enter the name for the new script: " script_name
		if [ -z "$script_name" ]; then
			log_e "Script name is required"
			myexit 1
		fi
	fi

	collection_name=${VALUES[1]}
	default_collection=$(get_default_collection)

	if [ -z "$collection_name" ] && [ "$interactive_mode" == "true" ]; then
		read -p "Enter the name for the collection ($default_collection): " collection_name
	fi

	if [ -z "$collection_name" ]; then
		collection_name=$default_collection
	fi

	if [ ! -d "$HOME_DIR/$collection_name" ]; then
		log_e "Collection '$collection_name' does not exist"
		myexit 1
	fi

	check_if_command_exists $script_name

	sc_dir="$HOME_DIR/$collection_name"

	if [ -d "$sc_dir/bin" ]; then
		sc_dir="$sc_dir/bin"
	fi

	if [ "$(is_flag_specified '-local' '-l')" == "true" ]; then
		sc_dir="."
	elif [ "$interactive_mode" == "true" ]; then
		read -p "Create local (y/N): " create_local
		if [ "$create_local" == "y" ] || [ "$create_local" == "Y" ] || [ "$create_local" == "yes" ] || [ "$create_local" == "YES" ]; then
			sc_dir="."
		fi
	fi

	add_manual="false"
	if [ "$(is_flag_specified '-man' '-m')" == "true" ]; then
		add_manual="true"
	elif [ "$interactive_mode" == "true" ]; then
		read -p "Add manual (y/N): " add_manual
		if [ "$add_manual" == "y" ] || [ "$add_manual" == "Y" ] || [ "$add_manual" == "yes" ] || [ "$add_manual" == "YES" ]; then
			add_manual="true"
		fi
	fi

	create_new_script $sc_dir $script_name "" "" "" $add_manual

	log "Script '$script_name' created ($sc_dir/$script_name)"

	if [ "$(is_flag_specified '-edit' '-e')" == "true" ]; then
		edcom=$(get_editor_command)
		$edcom $sc_dir/$script_name
	fi
	if [ "$(is_flag_specified '-quick-edit' '-qe')" == "true" ]; then
		edcom=$(get_quick_editor_command)
		$edcom $sc_dir/$script_name
	fi
}

# Print help for the new command
function new_help {
	log "  new|n <new-script> [collection-name] [flags]- Create a new script"
	log "      script-name - The name of the script to create"
	log "      collection-name - The name of the collection to add the script to. The default collection can be set in the config"
	log "      Flags:"
	log "          -edit|-e - Open the script in the editor after creation"
	log "          -interactive|-it - Run the command in interactive mode, prompting for missing values (the name is not required in this mode)"
	log "          -man|-m - Add a manual to the script"
	log "          -local|-l - Create the script in the current directory"
	log "          -quick-edit|-qe - Open the script in the editor after creation, using the quick editor command"
	log ""
}

# Short form of the new command
function n_command {
	new_command $*
}

###END###
